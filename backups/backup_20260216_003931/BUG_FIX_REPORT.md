# 🐛 Bug 修正報告 - 訂單狀態頁面刷新問題

**日期**: 2026-02-14  
**問題編號**: #001  
**嚴重程度**: 高（影響用戶體驗）  
**狀態**: ✅ 已修正

---

## 問題描述

### 症狀
手機用戶掃描 QR Code 點餐後，進入訂單狀態頁面，**下拉刷新頁面時會顯示「找不到此訂單」**，而不是正常顯示訂單進度。

### 影響範圍
- 所有手機用戶的訂單狀態頁面
- 影響用戶查看訂單進度的體驗

### 重現步驟
1. 手機掃描 QR Code 進入點餐頁面
2. 完成點餐並送出訂單
3. 進入訂單狀態頁面（正常顯示）
4. 下拉刷新頁面
5. ❌ 顯示「找不到此訂單」

---

## 根本原因分析

### 技術問題

1. **useEffect 依賴問題**
   - `useEffect` 依賴了 `fetchOrders` 函數
   - 每次元件重新渲染時，`fetchOrders` 都會是新的函數參考
   - 導致 `useEffect` 重複執行，產生競態條件

2. **狀態更新時機**
   - 從 Supabase 獲取資料後，Zustand store 的狀態更新需要時間
   - `getOrderById()` 在狀態更新前就被呼叫
   - 導致找不到訂單

3. **資料查詢方式**
   - 使用 `getOrderById()` selector
   - 在某些情況下可能返回過時的資料

---

## 解決方案

### 修改檔案
`src/customer/pages/OrderStatusPage.tsx`

### 關鍵修正

#### 1. 移除 fetchOrders 依賴
```typescript
// 之前
useEffect(() => {
  // ...
}, [fetchOrders, orderId]);

// 之後
useEffect(() => {
  // ...
}, [orderId]); // 只依賴 orderId
```

#### 2. 改用直接陣列搜尋
```typescript
// 之前
const order = useOrderStore((s) => s.getOrderById(orderId || ''));

// 之後
const orders = useOrderStore((s) => s.orders);
const order = orders.find(o => o.id === orderId);
```

#### 3. 加入延遲確保狀態更新
```typescript
await fetchOrders();
// 等待 100ms 確保狀態更新
await new Promise(resolve => setTimeout(resolve, 100));
```

#### 4. 加入 mounted flag
```typescript
let mounted = true;

// ...載入資料...

return () => {
  mounted = false;
  unsubscribe();
};
```

---

## 測試結果

### 測試環境
- 開發伺服器: http://localhost:5174
- 測試訂單: #39
- 測試設備: 手機（下拉刷新）

### 測試案例

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 首次載入頁面 | 顯示訂單詳情 | 顯示訂單詳情 | ✅ |
| 下拉刷新（第1次） | 顯示載入中 → 訂單詳情 | 顯示載入中 → 訂單詳情 | ✅ |
| 下拉刷新（第2次） | 顯示載入中 → 訂單詳情 | 顯示載入中 → 訂單詳情 | ✅ |
| 下拉刷新（第3次） | 顯示載入中 → 訂單詳情 | 顯示載入中 → 訂單詳情 | ✅ |
| 多次快速刷新 | 穩定運作 | 穩定運作 | ✅ |
| 即時訂閱更新 | 自動更新狀態 | 自動更新狀態 | ✅ |

---

## 程式碼變更

### 新增功能
- 加入載入狀態管理
- 加入 mounted flag 防止記憶體洩漏
- 改進錯誤處理

### 移除功能
- 移除除錯用的 console.log
- 移除除錯用的畫面顯示

### 優化
- 更可靠的訂單查詢方式
- 更好的狀態同步機制
- 更清晰的錯誤訊息

---

## 影響評估

### 正面影響
- ✅ 修正了嚴重的用戶體驗問題
- ✅ 提升了頁面刷新的穩定性
- ✅ 改善了狀態管理邏輯
- ✅ 減少了不必要的重新渲染

### 潛在風險
- ⚠️ 加入 100ms 延遲可能在某些情況下略微影響載入速度
- ✅ 經測試，延遲幾乎無法察覺

### 相容性
- ✅ 不影響其他頁面
- ✅ 向後相容
- ✅ 不需要資料庫遷移

---

## 後續建議

### 短期
- [x] 在其他頁面檢查類似的 useEffect 依賴問題
- [ ] 考慮在 MenuPage 和 CartPage 套用類似的優化
- [ ] 加入單元測試覆蓋這個修正

### 長期
- [ ] 考慮實作更完善的快取機制
- [ ] 評估是否需要使用 React Query 或 SWR
- [ ] 建立頁面載入效能監控

---

## 相關文件

- `INTEGRATION_COMPLETE.md` - Supabase 整合文件
- `PROJECT_LOG.md` - 專案開發日誌
- `src/customer/pages/OrderStatusPage.tsx` - 修正的檔案

---

## 結論

此 bug 已成功修正，經過多次測試確認穩定運作。修正方案不僅解決了問題，還改善了整體的狀態管理邏輯。建議在正式部署前再次進行完整的回歸測試。

**修正者**: Rovo Dev  
**測試者**: 用戶  
**審核狀態**: ✅ 已驗證

---

*最後更新: 2026-02-14 22:30*
